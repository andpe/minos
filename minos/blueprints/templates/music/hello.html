{% extends "header.html" %}
{% block content %}
<div class="container" id="content">
    <h2>Sonos queue</h2>
    <table class="table">
        <thead>
            <tr>
                <th class="col-xs-10">Name</th>
                <th class="col-xs-2"></th>
            </tr>
        </thead>
        <tbody>
            {% for track in tracks %}
                {% set track_uri = track.get_unique_id() %}
                <tr class="track-row {% if 1 == loop.index %} table-info{% endif %}" data-uri="{{ track.get_unique_id() }}">
                    <td>{{ track.title }} - {{ track.artist }}</td>
                    <td class="voteButtons">
                        <span class="fa fa-thumbs-up float-left {% if user_voted[track_uri] is defined and user_voted[track_uri] == 'up' %}liked{% endif %}"></span>
                        <span class="fa fa-thumbs-down float-right {% if user_voted[track_uri] is defined and user_voted[track_uri] == 'down' %}disliked{% endif %}"></span>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
{% block end_scripts %}
<script>
    $(document).ready(function() {
        $('.track-row td span.fa').on('click', function() {
            var $this = $(this);
            var uri = $this.closest('tr').data('uri');
            var offset = uri.indexOf('?'); // Trim any query string
            var direction = $this.hasClass('fa-thumbs-up');

            if(offset > 0)
                uri = uri.substr(0, offset);



            $.post(
                '/music/vote/' + uri + '/' + (direction ? 'up' : 'down'),
                function(data) {
                    var alrt = $('<div class="alert alert-dismissable alert-warning fade show"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>You have already voted for this track.</div>');

                    if(data != 'OK') {
                        $('.alerts').append(alrt);
                    } else {
                        if(direction) {
                            $this.closest('.voteButtons').find('.fa-thumbs-up').toggleClass('liked');
                        } else {
                            $this.closest('.voteButtons').find('.fa-thumbs-down').toggleClass('disliked');
                        }
                    }
                }
            );
        })

        var ws = new WebSocket('ws://localhost:8005/sub');
        ws.onmessage = function(message) {
            var obj = JSON.parse(message.data);
            console.log(obj.track + " was voted " + obj.direction);
        }
    })

</script>
{% endblock %}